<?php
/**
 * Custom template
 * Font loading based on https://web.dev/preload-critical-assets/
 */

$webFonts = $block->getWebFonts();
$localFonts = $block->getLocalFonts();
$localFontsFile = $block->getLocalFontsFile();
$localFontsExt = $block->getLocalFontsExt() ?? 'woff2';

if (!empty($webFonts)):
    /**
     * Loop through all web fonts defined in XML
     */
    foreach ($webFonts as $url):
        if (!empty($url)): ?>
            <?php if (strpos($url, 'fonts.googleapis') !== false): ?>
                <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
            <?php endif; ?>
            <link rel="preload" as="style" href="<?= $escaper->escapeUrl($url) ?>">
            <link id="font_webfont" rel="stylesheet" href="<?= $escaper->escapeUrl($url) ?>" media="print">
            <?= $secureRenderer->renderEventListenerAsTag('onload', "this.onload=null;this.media='all'", '#font_webfont'); ?>
            <noscript><link rel="stylesheet" href="<?= $escaper->escapeUrl($url) ?>"></noscript>
        <?php endif;
    endforeach;
endif;

if (!empty($localFontsFile)):
    /**
     * Loop through all local fonts files defined in XML
     */
    foreach ($localFontsFile as $fontFile):
        if (!empty($fontFile)):
            $localFontUrl = $this->getViewFileUrl($fontFile); ?>
            <link rel="preload" href="<?= $escaper->escapeUrl($localFontUrl); ?>" as="font" type="font/<?= $localFontsExt; ?>" crossorigin>
        <?php endif;
    endforeach;
endif;

if (!empty($localFonts)):
    /**
     * Loop through all fonts CSS files defined in XML
     * TODO: Temporary backward compability solution. Cleanup conditions on new major release of theme-creative shop
     */
    if (!empty($localFontsFile)) {
        foreach ($localFonts as $fontCSS):
            if (!empty($fontCSS)):
                $localFontUrl = $this->getViewFileUrl($fontCSS); ?>
                <link rel="stylesheet" href="<?= $escaper->escapeUrl($localFontUrl) ?>" as="style">
            <?php endif;
        endforeach;
    } else {
        foreach ($localFonts as $fontCSS):
            if (!empty($fontCSS)):
                $localFontUrl = $this->getViewFileUrl($fontCSS); ?>
                <link rel="preload" as="style" href="<?= $escaper->escapeUrl($localFontUrl) ?>">
                <link id="font_localfont" rel="stylesheet" href="<?= $escaper->escapeUrl($localFontUrl) ?>" media="print">
                <?= $secureRenderer->renderEventListenerAsTag('onload', "this.media='all'", '#font_localfont'); ?>
                <noscript><link rel="stylesheet" href="<?= $escaper->escapeUrl($localFontUrl) ?>"></noscript>
            <?php endif;
        endforeach;
    }
endif;
?>
