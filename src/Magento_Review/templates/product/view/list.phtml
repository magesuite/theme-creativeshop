<?php
/**
 * Template overridden in order to:
 * - move list-item into separate phtml file
 * - add magesuite classes
 *
 * Aligned with Magento 2.4.7 in 04/2024
 */

use Magento\Framework\Escaper;
use Magento\Framework\View\Helper\SecureHtmlRenderer;
use Magento\Review\Block\Product\View\ListView;

/**
 * @var ListView $block
 * @var SecureHtmlRenderer $secureRenderer
 * @var Escaper $escaper
 */

$_items = $block->getReviewsCollection()->getItems();
$format = $block->getDateFormat() ?: \IntlDateFormatter::SHORT;
?>
<?php if (count($_items)): ?>
    <div class="cs-reviews__content" id="customer-reviews">
        <ol class="cs-reviews__list">
            <?php  foreach ($_items as $_review): ?>
                <?php
                $createdAt = $_review->getCreatedAt();
                $ratingVotes = $_review->getRatingVotes();
                $ratingCategoriesCount = count($ratingVotes);
                $compoundRatings = [];
                $overallScore = null;

                if ($ratingCategoriesCount) {
                    $percentageRatingsList = array_map(function ($vote) {
                        return $vote->getPercent();
                    }, iterator_to_array($ratingVotes));

                    $averagePercentageRating = array_sum($percentageRatingsList)/$ratingCategoriesCount;
                    $overallScore = round($averagePercentageRating/20);
                }

                if ($ratingCategoriesCount > 1) {
                    foreach ($ratingVotes as $rating) {
                        array_push($compoundRatings, [
                            'ratingCode' => $rating->getRatingCode(),
                            'score' => ($rating->getPercent()/20)
                            ]);
                    }
                }
                ?>

                <li class="cs-reviews__item">
                    <?= $this->getLayout()
                             ->createBlock(\Magento\Framework\View\Element\Template::class)
                             ->setTemplate('Magento_Review::product/view/list-item.phtml')
                             ->setTitle($block->escapeHtml($_review->getTitle()))
                             ->setRatingData([
                                "maxStars" => 5,
                                "overallScore" => $overallScore,
                                "compoundRatings" => $compoundRatings
                             ])
                             ->setReviewConfigurationData($_review->getData('review_configuration_data'))
                             ->setAuthor($block->escapeHtml($_review->getNickname()))
                             ->setDate($block->formatDate($createdAt, $format))
                             ->setContent(nl2br($block->escapeHtml($_review->getDetail())))
                             ->toHtml();
                    ?>
                </li>
            <?php endforeach; ?>
        </ol>
    </div>
    <?= $block->getChildHtml('toolbar') ?>
<?php endif; ?>
